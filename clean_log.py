import os
import re
import shutil
from pathlib import Path
from typing import List, Tuple, Dict, Optional


def is_timestamp_folder(folder_name: str) -> bool:
    """æ£€æŸ¥æ–‡ä»¶å¤¹åæ˜¯å¦ä¸ºæ—¶é—´æˆ³æ ¼å¼ï¼šYYYY-MM-DD-HH-MM-SS"""
    pattern = r'^\d{4}-\d{2}-\d{2}-\d{2}-\d{2}-\d{2}$'
    return bool(re.match(pattern, folder_name))


def check_strict_mode(exp_path: Path) -> bool:
    """ä¸¥æ ¼æ¨¡å¼æ£€æŸ¥ï¼šæ˜¯å¦å­˜åœ¨ experiment_finished.txt ä¸”å†…å®¹ä¸º YES"""
    finished_file = exp_path / "experiment_finished.txt"
    if not finished_file.exists():
        return False

    try:
        with open(finished_file, 'r', encoding='utf-8') as f:
            content = f.read().strip()
            return content.upper() == "YES"
    except Exception:
        return False


def check_gentle_mode(exp_path: Path) -> bool:
    """æ¸©å’Œæ¨¡å¼æ£€æŸ¥ï¼šå­˜åœ¨ç‰¹å®šç»“æœæ–‡ä»¶å¤¹ä¸ºæœ‰æ•ˆï¼Œåªæœ‰ä¸­é—´è¾“å‡ºæ–‡ä»¶å¤¹ä¸ºæ— æ•ˆ"""
    epoch_pattern = [re.compile(r'^epoch\d+$'), re.compile(r'^test_epoch_\d+$')]

    has_result_folder = False
    has_only_intermediate_folders = True

    for item in exp_path.iterdir():
        if item.is_dir():
            folder_name = item.name

            if folder_name.startswith('.'):
                continue

            is_intermediate = (
                    folder_name == 'train_output' or
                    folder_name == 'val_output' or
                    folder_name == 'final_test' or
                    any([bool(pattern.match(folder_name)) for pattern in epoch_pattern])
            )

            if not is_intermediate:
                print(f"Find {item}")
                has_result_folder = True
                has_only_intermediate_folders = False
                break
            else:
                pass

    if has_result_folder:
        return True
    elif has_only_intermediate_folders and any(exp_path.iterdir()):
        return False
    else:
        return False


def analyze_experiment_results(
        log_dir: str,
        mode: str = "strict",
        verbose: bool = True
) -> Dict[str, List[str]]:
    """
    åˆ†æå®éªŒæ—¥å¿—ç›®å½•ï¼Œè¯†åˆ«æ— æ•ˆå®éªŒç»“æœ

    Args:
        log_dir: æ—¥å¿—ç›®å½•è·¯å¾„
        mode: æ£€æŸ¥æ¨¡å¼ï¼Œ"strict" æˆ– "gentle"
        dry_run: æ˜¯å¦ä»…æ¨¡æ‹Ÿè¿è¡Œï¼ˆä¸å®é™…åˆ é™¤ï¼‰
        verbose: æ˜¯å¦æ‰“å°è¯¦ç»†ä¿¡æ¯

    Returns:
        åŒ…å«åˆ é™¤å’Œä¿ç•™åˆ—è¡¨çš„å­—å…¸
    """
    log_path = Path(log_dir)

    if not log_path.exists():
        print(f"é”™è¯¯ï¼šç›®å½• {log_dir} ä¸å­˜åœ¨")
        return {"to_delete": [], "to_keep": []}

    # é€’å½’æŸ¥æ‰¾æ‰€æœ‰å­ç›®å½•
    timestamp_folders = []
    for item in log_path.rglob('*'):
        if item.is_dir() and is_timestamp_folder(item.name):
            timestamp_folders.append(item)

    if verbose:
        print(f"åœ¨ {log_dir} ä¸­æ‰¾åˆ° {len(timestamp_folders)} ä¸ªå®éªŒæ–‡ä»¶å¤¹")

    # æ£€æŸ¥æ¯ä¸ªå®éªŒæ–‡ä»¶å¤¹
    to_delete = []
    to_keep = []

    for exp_folder in timestamp_folders:
        if mode == "strict":
            is_valid = check_strict_mode(exp_folder)
        else:  # gentle mode
            is_valid = check_gentle_mode(exp_folder)

        if is_valid:
            to_keep.append(str(exp_folder))
        else:
            to_delete.append(str(exp_folder))

    # æ‰“å°ç»“æœ
    if verbose:
        print("\n" + "=" * 60)
        print(f"æ£€æŸ¥æ¨¡å¼: {mode}")
        print(f"æœ‰æ•ˆå®éªŒ: {len(to_keep)} ä¸ª")
        print(f"æ— æ•ˆå®éªŒ: {len(to_delete)} ä¸ª")

        if to_keep:
            print("\nâœ… å°†ä¿ç•™çš„å®éªŒ:")
            for i, path in enumerate(to_keep):
                print(f"  {i}. {path}")

        if to_delete:
            print("\nğŸ—‘ï¸  å°†åˆ é™¤çš„å®éªŒ:")
            for i, path in enumerate(to_delete):
                print(f"  {i}. {path}")
        print("=" * 60)

    # è®¡ç®—æ€»å¤§å°
    if to_delete:
        total_size = 0
        for folder in to_delete:
            folder_path = Path(folder)
            total_size += sum(f.stat().st_size for f in folder_path.rglob('*') if f.is_file())

        if verbose:
            print(f"\nğŸ“Š é¢„è®¡é‡Šæ”¾ç©ºé—´: {total_size / 1024 ** 2:.2f} MB")

    print("\nâš ï¸  è­¦å‘Šï¼šè¿™å°†åœ¨ç£ç›˜ä¸Šå®é™…åˆ é™¤æ–‡ä»¶ï¼")
    confirm = input(f"ç¡®è®¤åˆ é™¤ {len(to_delete)} ä¸ªå®éªŒæ–‡ä»¶å¤¹ï¼Ÿ(è¾“å…¥ 'yes' ç¡®è®¤): ")

    if confirm.lower() == 'yes':
        print("å¼€å§‹åˆ é™¤...")
        for folder in to_delete:
            try:
                shutil.rmtree(folder)
                print(f"  å·²åˆ é™¤: {os.path.basename(folder)}")
            except Exception as e:
                print(f"  åˆ é™¤ {folder} æ—¶å‡ºé”™: {e}")
        print("åˆ é™¤å®Œæˆï¼")
    else:
        print("æ“ä½œå·²å–æ¶ˆ")

    return {
        "to_delete": to_delete,
        "to_keep": to_keep,
        "mode": mode,
        "total_folders": len(timestamp_folders)
    }


if __name__ == "__main__":
    log_path = "log"
    results = analyze_experiment_results(log_path, mode="gentle")
